/*
 * uart.c
 *
 *  Created on: Aug 16, 2017
 *      Author: agustin
 */

/********************************************************************************************************
*** INCLUDES
********************************************************************************************************/

#include "uart.h"
#include "My_Types.h"
#include "nvic.h"
#include "LPC17xx.h"

#include "ring_buffer.h"

/********************************************************************************************************
*** PRIVATE DEFINES
********************************************************************************************************/

/********************************************************************************************************
*** PRIVATE MACROS
********************************************************************************************************/

/********************************************************************************************************
*** PRIVATE DATA TYPES
********************************************************************************************************/
volatile static unsigned char bufferTx=0;

/********************************************************************************************************
*** PRIVATE TABLES
********************************************************************************************************/

/********************************************************************************************************
*** PUBLIC GLOBAL VARIABLES
********************************************************************************************************/

/********************************************************************************************************
*** PRIVATE GLOBAL VARIABLES
********************************************************************************************************/

/********************************************************************************************************
*** PRIVATE FUNCTION PROTOTYPES
********************************************************************************************************/
static void startTx(void);
/********************************************************************************************************
*** CONFIGURATION ERRORS
********************************************************************************************************/

/********************************************************************************************************
*** PUBLIC FUNCTIONS
********************************************************************************************************/
void UART_Init()
{
	// Implementar esta funcion para UART0 - 115200 - 8, N, 1

	SC_PCONP |= (0x01 << 3);			//Enciendo la UART0
	//pclk = 12.5 MHz
	SC_PCLKSEL0 |= (0x03 << 6);

	GPIO_SetPinFunc( PORT_0, PIN_2, FIRST_ALT_FUNC);
	GPIO_SetPinFunc( PORT_0, PIN_3, FIRST_ALT_FUNC);

	//U0LSR |= LCR_WLS8;
	//U0LSR |= LCR_SBS1;
	//U0LSR |= LCR_DL;
	U0LCR = 0x83;

	//9600 baudrate

	//Fdiv  = (pclk / 16) / baudrate;
	U0DLM = 0;
	U0DLL = 73;

	U0FDR |= ( 1 << 0);
	U0FDR |= ( 9 << 4);

	U0LCR &= ~LCR_DL;
	//U0FCR = 0x00;

	NVIC_EnableIRQ( UART0_IRQn);
	U0IER |= IER_RBR;
	U0IER |= IER_THR;

}
void UART_PushTx(unsigned char dato)
{
	bufferTx = dato;
	startTx();
}

char UART_PopTx(void)
{
	unsigned char dato = bufferTx;

	bufferTx = '\0';

	return dato;
}

void startTx(void)
{
	U0THR = bufferTx;
	bufferTx = '\0';

}


void UART0_IRQHandler(void)
{
	unsigned char IIR;
	uint8_t dato;

	do
	{
		IIR = U0IIR;

		switch(IIR_IntIdU(IIR))
		{
			case IIR_RBR:
				dato = U0RBR;
				RingBuffer_PushData(dato);
				break;

			case IIR_THER:
				dato = UART_PopTx();
				if(dato != '\0')
				{
					U0THR = dato;
				}
				break;
		}
	}while(!(IIR & 0x01));
}

